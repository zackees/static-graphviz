FROM ubuntu:22.04

# Update
RUN apt-get update

# Install required tools and Graphviz runtime dependencies
RUN apt-get install -y \
    curl \
    xz-utils \
    dpkg \
    file \
    patchelf \
    libpoppler-glib8 \
    librsvg2-2 \
    ghostscript \
    liblasi0 \
    libdevil1c2 \
    libgts-0.7-5 \
    libltdl7 \
    libgd3 \
    libgtk-3-0 \
    libcairo2 && \
    apt-get clean

RUN apt-get install -y \
    libgraphviz-dev \
    libgvc6 \
    libcgraph6 \
    libcdt5 \
    libxdot4 \
    libtiff5 \
    libijs-0.35 \
    libjbig2dec0 \
    libidn12 \
    libpaper1



# Environment variables
ENV GV_URL=https://gitlab.com/api/v4/projects/4207231/packages/generic/graphviz-releases/12.2.1/ubuntu_22.04_graphviz-12.2.1-debs.tar.xz
ENV GV_FILENAME=ubuntu_22.04_graphviz-12.2.1-debs.tar.xz
ENV OUTPUT_FILENAME=graphviz_libraries_executables-12.2.1.tar.xz

WORKDIR /workspace

# Debug library scan
RUN echo "ðŸ”Ž Scanning for common system libs..." && \
    for name in libgs libIL libILU libpoppler-glib librsvg-2 libLASi libgts; do \
        echo "ðŸ” Searching for $name.so* ..."; \
        find / -type f -name "$name.so*" 2>/dev/null || echo "âš ï¸  Not found: $name.so*"; \
    done

# Download and extract Graphviz DEBs
RUN curl -L "$GV_URL" -o "$GV_FILENAME"
RUN mkdir -p debs extracted bins
RUN tar -xf "$GV_FILENAME" -C debs
RUN for deb in debs/*.deb; do dpkg-deb -x "$deb" extracted/; done

# Plugin validation
RUN echo "ðŸ” Checking for libgvplugin_lasi.so.6.0.0..." && \
    (find extracted -name 'libgvplugin_lasi.so.6.0.0' -exec echo "âœ… Found: {}" \; || echo "âŒ Not found")

# Copy binaries and libraries
RUN [ -d extracted/usr/bin ] && cp -a extracted/usr/bin/* bins/ || true
RUN [ -d extracted/usr/lib ] && cp -a extracted/usr/lib/* bins/ || true

# Copy specific plugin dependencies
RUN cp --parents -d $(find extracted/usr/lib -name 'libxdot.so*') bins/ || true

# Copy libxdot.so.4* from system library paths
RUN echo "ðŸ“Ž Copying system libxdot.so.4* into bins/..." && \
    find /usr/lib /lib -name 'libxdot.so.4*' -exec cp --parents -d {} /workspace/bins/ \;


RUN cp --parents -d $(find extracted/usr/lib -name 'libpathplan.so*') bins/ || true
RUN cp --parents -d $(find extracted/usr/lib -name 'libcdt.so*') bins/ || true
RUN for dir in extracted/usr/lib extracted/usr/lib/x86_64-linux-gnu extracted/usr/lib/graphviz; do \
        [ -d "$dir" ] && find "$dir" \( -type f -o -type l \) -name '*.so*' -exec cp --parents -d {} bins/ \;; \
    done

# Print what we collected
RUN echo "ðŸ“‹ Copied shared libraries:" && find bins -name '*.so*'
RUN echo "âœ… Expecting libgvc, libcgraph, etc. to now appear:" && \
    find bins -name 'libgvc*.so*' && find bins -name 'libcgraph*.so*'


# Copy libgvc/libcgraph early to ensure ldd doesn't fail
RUN echo "ðŸ“¦ Ensuring libgvc and libcgraph are copied early..." && \
    find extracted -type f \( -name 'libgvc.so*' -o -name 'libcgraph.so*' \) -exec cp --parents -d {} bins/ \;

# Copy core libs into every plugin dir to ensure $ORIGIN RPATH works
RUN echo "ðŸ“Ž Copying libgvc/libcgraph into plugin dirs..." && \
    find bins -name 'libgvplugin_*.so*' -exec dirname {} \; | sort -u | while read dir; do \
        cp bins/libgvc.so.* "$dir/" || true; \
        cp bins/libcgraph.so.* "$dir/" || true; \
    done

# Auto-copy specific shared libraries needed by libgvplugin_gs.so.6.0.0
RUN echo "ðŸ“Ž Copying missing dependencies for libgvplugin_gs.so.6.0.0..." && \
    for lib in libtiff.so.5 libijs-0.35.so libjbig2dec.so.0 libidn.so.12 libpaper.so.1; do \
        path=$(ldconfig -p | grep "$lib" | awk '{print $NF}' | head -n1); \
        if [ -f "$path" ]; then \
            echo "ðŸ“Ž Copying $lib from $path"; \
            cp --parents -d "$path" /workspace/bins/; \
        else \
            echo "âš ï¸  $lib not found in ldconfig output"; \
        fi; \
    done

# ðŸš« Strip unsafe system libs
RUN find bins/graphviz -name 'libc.so.*' -delete && \
    find bins/graphviz -name 'libpthread.so.*' -delete && \
    find bins/graphviz -name 'ld-linux*.so.*' -delete && \
    find bins/graphviz -name 'libm.so.*' -delete && \
    find bins/graphviz -name 'libdl.so.*' -delete && \
    find bins/graphviz -name 'librt.so.*' -delete


RUN echo "ðŸ“Ž Copying verified resolved GS plugin dependencies..." && \
    for lib in libtiff.so.5 libijs-0.35.so libjbig2dec.so.0 libidn.so.12 libpaper.so.1; do \
        find /lib /usr/lib /usr/lib/x86_64-linux-gnu -name "$lib" -exec cp --parents -d {} /workspace/bins/ \; || echo "âš ï¸ $lib not found"; \
    done

# Patch RPATHs after plugin placement
RUN echo "ðŸ”§ Patching RPATH for executable ELF files..." && \
    find bins -type f -exec file {} \; | grep "ELF.*executable" | cut -d: -f1 | while read exe; do \
        echo "ðŸ”§ Setting RPATH for $exe"; \
        patchelf --set-rpath '$ORIGIN' "$exe"; \
    done

RUN echo "ðŸ”§ Patching RPATH for plugin .so files..." && \
    find bins -type f -name 'libgvplugin_*.so*' -exec patchelf --set-rpath '$ORIGIN' {} \;

# Resolve plugin dependencies with ldd
RUN echo "ðŸ”— Resolving plugin dependencies with ldd..." && \
    find bins -type f -name 'libgvplugin_*.so*' | while read plugin; do \
        echo "ðŸ§© ldd $plugin:"; \
        ldd "$plugin" | awk '{ print $1, $2, $3 }' | while read name arrow path; do \
            if [ "$arrow" = "=>" ] && [ "$path" != "not" ]; then \
                echo "ðŸ“Ž Copying $name => $path"; \
                cp --parents -d "$path" bins/ || { echo "âŒ Failed to copy $path"; exit 1; }; \
            elif [ "$arrow" = "=>" ] && [ "$path" = "not" ]; then \
                echo "âŒ Missing dependency: $name"; exit 1; \
            fi; \
        done; \
    done

# ðŸ©¹ Manually ensure GS plugin dependencies go to bins/
RUN echo "ðŸ“Ž Forcing GS plugin dependencies into bins/..." && \
    for lib in libtiff.so.5 libijs-0.35.so libjbig2dec.so.0 libidn.so.12 libpaper.so.1; do \
        path=$(ldconfig -p | grep "$lib" | awk '{print $NF}' | head -n1); \
        if [ -f "$path" ]; then \
            echo "ðŸ“Ž Copying $lib from $path -> bins/"; \
            cp -d "$path" bins/ || echo "âš ï¸  Failed to copy $lib"; \
        else \
            echo "âš ï¸  $lib not found in ldconfig output"; \
        fi; \
    done


# âœ… Finda nd copy runtime dependencies missed by ldd
RUN echo "ðŸ“Ž Recursively resolving all shared library dependencies..." && \
    set -e && \
    mkdir -p bins/graphviz && \
    find bins -type f -executable -o -name '*.so*' | while read -r sofile; do \
        echo "ðŸ” Scanning $sofile"; \
        ldd "$sofile" | awk '/=>/ && $3 ~ /^\// { print $3 }' \
            | sort -u >> /tmp/all-libs.txt || true; \
    done && \
    sort -u /tmp/all-libs.txt > /tmp/all-libs.sorted.txt && \
    echo "ðŸ“¦ Copying discovered libs..." && \
    while read -r libpath; do \
        [ -f "$libpath" ] || continue; \
        echo "ðŸ“Ž Copying $libpath"; \
        mkdir -p "$(dirname "bins/$libpath")"; \
        cp -d "$libpath" "bins/$libpath" || true; \
        cp "$libpath" bins/graphviz/ || true; \
    done < /tmp/all-libs.sorted.txt && \
    echo "âœ… All transitive shared libs copied"


RUN echo "ðŸ”§ Re-patching RPATH for all .so files to use \$ORIGIN..." && \
    find bins -type f -name '*.so*' -exec patchelf --set-rpath '$ORIGIN' {} \;

# Create archive
RUN echo "ðŸ“¦ Creating final archive..." && \
    tar -cJf "$OUTPUT_FILENAME" -C bins .

# Verify contents
RUN echo "ðŸ§¾ Verifying archive contents..." && \
    tar -tvf "$OUTPUT_FILENAME" | grep -E 'libgvplugin_.*\.so|libpoppler|librsvg|libgs|libIL|libLASi|libgvc|libcgraph' || echo "âš ï¸ Some items may still be missing"

# Final test: extract and test RPATH loading
RUN echo "ðŸ§ª Post-archive testing..." && \
    mkdir test_extract && \
    tar -xf "$OUTPUT_FILENAME" -C test_extract && \
    echo "ðŸ” ldd on test_extract/dot:" && ldd test_extract/dot || echo "âŒ dot ldd failed" && \
    echo "ðŸ” ldd on libgvplugin_gs.so.6.0.0:" && \
    LD_LIBRARY_PATH=test_extract/graphviz:test_extract ldd test_extract/graphviz/libgvplugin_gs.so.6.0.0 || echo "âš ï¸ Linking failed"

# Final confirmation
RUN echo "âœ… Final lib check:" && \
    find bins -name 'libgvc*.so*' && find bins -name 'libcgraph*.so*'

# Optionally copy result to a mounted volume
CMD ["/bin/bash", "-c", "if [ -d /host ] && [ -w /host ]; then cp \"/workspace/$OUTPUT_FILENAME\" /host/ && echo 'âœ… Archive copied to /host/'; else echo 'âš ï¸ No writable /host mount detected. Skipping copy.'; fi"]
